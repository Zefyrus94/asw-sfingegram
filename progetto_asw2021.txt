Comandi utili
docker ps -a
docker stop $(docker ps -a -q)
docker rm $(docker ps -a -q)
docker stop my-postgres
docker rm my-postgres
docker container restart my-postgres
#elenca i volumi creati
docker volume ls -f dangling=tru
#elimina i volumi non utilizzati da almeno un container
docker volume prune
#elimina le immagini che matchano un pattern
docker rmi $(docker images | grep '.*service')

@Accesso al db sfingegram-enigmiseguiti
psql --username=postgres --host=postgres_enigmiseguiti --dbname=sfingegram-enigmiseguiti

winpty docker exec -it 109b8ee2a729 bash
psql --host=database --username=postgres --dbname=sfingegram

#wmic process where "name='java.exe'" get ProcessID
#taskkill /pid 18396 /F

#Src: https://community.spiceworks.com/how_to/147835-use-wmic-to-end-running-processes

wmic process where "name='java.exe'" delete

cd C:/Users/giaco/Downloads/ASW/repo/asw2/asw/projects/asw-sfingegram/enigmi
gradle build

Tra le variabili di sistema bisogna avere
nel path: C:\Users\giaco\asw\Gradle\gradle-6.3\bin
JAVA_HOME C:\Program Files\Java\jdk-11.0.11


Comandi da eseguire
#esegue consul su un container, fa la build del codice Java ed esegue l'applicazione spring
cd C:/Users/giaco/Downloads/ASW/repo/asw2/asw/projects/asw-sfingegram
gradle build
sh start-consul.sh
sh run-sfingegram.sh


Shell2
cd C:/Users/giaco/Downloads/ASW/repo/asw2/asw/projects/asw-sfingegram
#innestare i primi dati con delle curl
sh do-init-enigmi.sh
sh do-init-connessioni.sh

http://localhost:8080/
#Posso ora vedere gli enigmi
http://localhost:8080/enigmi/enigmi
localhost:8080/enigmi/enigmi/1
localhost:8080/enigmi/enigmi/1/soluzione
localhost:8080/enigmi/cercaenigmi/autore/Il Mancino
localhost:8080/enigmi/cercaenigmi/tipo/Indovinello
http://localhost:8080/enigmi/cercaenigmi/autori/Il%20Mancino,Il%20Valletto
localhost:8080/enigmi/cercaenigmi/tipi/Indovinello,Anagramma

localhost:8080/connessioni/connessioniconautori
localhost:8080/connessioni/connessionicontipi
localhost:8080/connessioni/connessioniconautori/Alice
localhost:8080/connessioni/connessionicontipi/Alice

docker run --name some-postgres -e POSTGRES_PASSWORD=mysecretpassword -d postgres
Se uso docker exec -it some-postgres bash
$ docker exec -it some-postgres bash
the input device is not a TTY.  If you are using mintty, try prefixing the command with 'winpty'
Quindi [src: https://stackoverflow.com/questions/48623005/docker-error-the-input-device-is-not-a-tty-if-you-are-using-mintty-try-prefi/49965690]
winpty docker exec -it some-postgres bash
su postgres
psql
\conninfo
\q
exit
------
[src: https://stackoverflow.com/questions/38713597/create-table-in-postgresql-docker-image/38714511]
Creo un Dockerfile
FROM postgres:9.3
ENV POSTGRES_USER docker
ENV POSTGRES_PASSWORD docker
ENV POSTGRES_DB docker
ADD CreateDB.sql /docker-entrypoint-initdb.d/


CREATE TABLE enigmi (
    tipo text NOT NULL,
    titolo text NOT NULL,
    testo text NOT NULL,
    autore text NOT NULL,
    soluzione text
);

#costruisco l'immagine con una tabella
docker build -t my-postgres .
#non uso l'opzione detached (-d my-postgres )
docker run --name=my-postgres my-postgres -v ~/projects/www:/var/www
#il container deve essere in esecuzione per accettare nuove connessioni al db
winpty docker exec -it my-postgres bash
psql -h localhost -p 5432 -U docker -d docker
\c
\dt


#Creo un dockerfile sotto enigmi
docker build -t enigmi .
docker run --name=enigmi enigmi

Prendevo questo errore
2021-05-18 16:47:06.146 ERROR 1 --- [TaskScheduler-1] o.s.c.c.discovery.ConsulDiscoveryClient  : Error watching Consul CatalogServices

com.ecwid.consul.transport.TransportException: org.apache.http.conn.HttpHostConnectException: Connect to localhost:8500 [localhost/127.0.0.1] failed: Connection refused (Connection refused)

Ho modificato enigmi/...resources/application.yml
localhost Ã¨ diventato
host.docker.internal

Il servizio viene ora registrato, ma gli health check falliscono

Altre info
https://app.diagrams.net/


DOCKER-COMPOSE
version: '3'
services:
  zookeeper:
    image: wurstmeister/zookeeper
    ports:
      - "2181:2181"
  kafka:
    image: wurstmeister/kafka:latest
    depends_on:
      - "zookeeper"
    ports:
      - "9092:9092"
    environment:
      KAFKA_ADVERTISED_HOST_NAME: 10.11.1.121
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_CREATE_TOPICS: "restaurant-service-event-channel:4:1,restaurant-service-command-channel:4:1"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock

docker-compose up -d 
#entra nel container con kafka
winpty docker exec -it a0d4f3457bb5 bash
kafka-topics.sh --list --zookeeper zookeeper:2181



#list all available brokers in zookeeper (da eseguire sul container con kafka)
zookeeper-shell.sh localhost:2181 ls /brokers/ids

find . -type f -print0 | xargs -0 dos2unix

bash-4.4# zookeeper-shell.sh zookeeper:2181 ls /brokers/ids
Connecting to zookeeper:2181

WATCHER::

WatchedEvent state:SyncConnected type:None path:null
[1001]

bash-4.4# zookeeper-shell.sh zookeeper:2181 ls /brokers/topics
Connecting to zookeeper:2181

WATCHER::

WatchedEvent state:SyncConnected type:None path:null
[connessione-service-event-channel, enigma-service-event-channel]

[connessione-service-event-channel, enigma-service-event-channel]
bash-4.4# zookeeper-shell.sh zookeeper:2181 get /brokers/ids/1001
Connecting to zookeeper:2181

WATCHER::

WatchedEvent state:SyncConnected type:None path:null
{"features":{},"listener_security_protocol_map":{"PLAINTEXT":"PLAINTEXT"},"endpo
ints":["PLAINTEXT://10.11.1.121:9092"],"jmx_port":-1,"port":9092,"host":"10.11.1
.121","version":5,"timestamp":"1621443494204"}

src: https://stackoverflow.com/questions/40146921/how-to-list-all-available-kafka-brokers-in-a-cluster
src: https://github.com/wurstmeister/kafka-docker/issues/218


Quando provo a leggere i messaggi su un topic:
kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic enigma-service-event-channel --from-beginning

[2021-05-19 17:18:14,760] INFO [GroupCoordinator 1001]: Preparing to rebalance group console-consumer-22686 in state PreparingRebalance with old generation 0 (__consumer_offsets-35) (reason: Adding new member consumer-console-consumer-22686-1-cc190012-e292-4ee4-aa42-f22ea6a3d3c7 with group instance id None) (kafka.coordinator.group.GroupCoordinator)

[2021-05-19 17:18:14,761] INFO [GroupCoordinator 1001]: Stabilized group console-consumer-22686 generation 1 (__consumer_offsets-35) (kafka.coordinator.group.GroupCoordinator)

[2021-05-19 17:18:14,767] INFO [GroupCoordinator 1001]: Assignment received from leader for group console-consumer-22686 for generation 1 (kafka.coordinator.group.GroupCoordinator)

Quando termino il comando

[2021-05-19 17:19:50,827] INFO [GroupCoordinator 1001]: Member[group.instance.id None, member.id consumer-console-consumer-22686-1-cc190012-e292-4ee4-aa42-f22ea6a3d3c7] in group console-consumer-22686 has left, removing it from the group (kafka.coordinator.group.GroupCoordinator)

[2021-05-19 17:19:50,827] INFO [GroupCoordinator 1001]: Preparing to rebalance group console-consumer-22686 in state PreparingRebalance with old generation 1 (__consumer_offsets-35) (reason: removing member consumer-console-consumer-22686-1-cc190012-e292-4ee4-aa42-f22ea6a3d3c7 on LeaveGroup) (kafka.coordinator.group.GroupCoordinator)

[2021-05-19 17:19:50,827] INFO [GroupCoordinator 1001]: Group console-consumer-22686 with generation 2 is now empty (__consumer_offsets-35) (kafka.coordinator.group.GroupCoordinator)

#Per controllare quale processo sta in ascolto sulla 8080
netstat -aon | findstr 8080



Field domainEventPublisher in asw.sfingegram.enigmi.domain.EnigmiService required a bean of type 'asw.sfingegram.enigmi.domain.EnigmaDomainEventPublisher' that could not be found.

The injection point has the following annotations:
        - @org.springframework.beans.factory.annotation.Autowired(required=true)


Action:

Consider defining a bean of type 'asw.sfingegram.enigmi.domain.EnigmaDomainEventPublisher' in your configuration.

Pubblicare messaggi tramite script
echo "test 1" | kafka-console-producer.sh --broker-list localhost:9092 --topic enigma-service
-event-channel


https://docs.microsoft.com/en-us/visualstudio/docker/tutorials/persist-your-data

https://medium.com/analytics-vidhya/getting-started-with-postgresql-using-docker-compose-34d6b808c47c


https://graspingtech.com/docker-compose-postgresql/
https://stackoverflow.com/questions/59715622/docker-compose-and-create-db-in-postgres-on-init

https://dzone.com/articles/spring-boot-and-postgresql